#!/bin/bash

usage() {
  echo "notes : Take notes in markdown

  notes                   # Fuzzy finder to select a note and edit it in nvim
  notes open              # Fuzzy finder to select a note and open in firefox
  notes list              # List notes as a tree
  notes add k8s/test      # Add a new note k8s/test.md
  notes delete k8s/test   # Delete this note
  notes commit mycommit   # Commit notes to git with message mycommit"
}

getFile() {
  file=$(find ~/workspace/notes -type f -name "*.md" -not -path '*/.git/*' | cut -sd / -f 6- | fzf --preview 'bat --style numbers,changes --color always ~/workspace/notes/{}')
  echo $file
}

commit() {
  msg=$1
  if [[ -z $msg ]]
  then
    msg="Notes saved on : $(date)"
  fi
  cd ~/workspace/notes ; git add .; git commit -m "$msg";
}

open() {
  file=$(getFile)
  if [[ -z $file ]]
  then
    echo "No file specified"
    exit 1
  fi
  google-chrome-stable "~/workspace/notes/$file"
}

preview() {
  file=$(getFile)
  if [[ -z $file ]]
  then
    echo "No file specified"
    exit 1
  fi
  bat -p ~/workspace/notes/$file
}

list() {
  tree ~/workspace/notes
}

edit() {
  file=$(getFile)
  if [[ -z $file ]]
  then
    echo "No file specified"
    exit 1
  fi

  cd ~/workspace/notes; nvim $file
}

add() {
  file=$1

  if [[ -z $file ]]
  then
    echo "No file specified"
    exit 1
  fi

  if [ ! ${file: -3} == ".md" ]; then
    file=$file.md
  fi

  filePath=~/workspace/notes/$file
  dir=${filePath%/*}

  mkdir -p $dir
  existing=true

  if [ -f $filePath ]; then
    echo "Note already exists"
    exit 1
  fi

  title=$(basename $file)
  cd ~/workspace/notes
  nvim \
    -c "norm Gi# $1" \
    -c "norm G2o" \
    -c "startinsert" $filePath

}

delete() {
  file=$1

  if [[ -z $file ]]
  then
    echo "No file specified"
    exit 1
  fi

  if [ ! ${file: -3} == ".md" ]; then
    file=$file.md
  fi

  filePath=~/workspace/notes/$file

  if [ ! -f $filePath ]; then
    echo "Note doesn't exist"
    exit 1
  fi

  read -p "Are you sure? [y/N] " -n 1 REPLY
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]
  then
    rm $filePath
  fi

}


if [ "$#" == "0" ]; then
  edit
	exit 1
fi

cmd=$1
shift

case $cmd in 
   add)
     add $1
;;
   edit)
     edit
;;
   list)
     list
;;
   open)
     open
;;
   preview)
     preview
;;
   delete)
     delete $1
;;
   commit)
     commit $1
;;
   *)
     usage
     exit 1
;;
esac
